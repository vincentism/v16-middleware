# Next.js Middleware 测试用例清单

本文档提供了完整的测试用例清单，用于验证 Next.js 中间件在不同版本下的功能，特别是在 边缘平台 平台上的部署验证。

## 使用说明

- 在每个测试用例前使用 `- [ ]` 或 `- [x]` 来标记测试状态
- 记录测试结果和遇到的问题
- 针对不同版本分别测试

---

## 测试环境信息

**测试日期**: 2026-01-20

**测试人员**: tomcomtang

**边缘平台 环境**: 
- [ ] 开发环境
- [ ] 生产环境

**Node.js 版本**: 

---

## 一、Next.js 12.x 测试用例

### 1.1 基础功能测试

#### 路径匹配
- [ ] **TC-12-001**: 访问 `/api/test`，验证中间件执行
  - 预期: 响应头包含 `x-middleware-version: v12`
  - 实际结果: 

- [ ] **TC-12-002**: 访问 `/dashboard`，验证中间件执行
  - 预期: 响应头包含中间件标识
  - 实际结果: 

- [ ] **TC-12-003**: 访问 `/favicon.ico`，验证中间件不执行
  - 预期: 响应头不包含中间件标识
  - 实际结果: 

#### 请求重定向
- [ ] **TC-12-004**: 访问 `/old`，验证重定向到 `/new`
  - 预期: HTTP 状态码 307/308，Location 头指向 `/new`
  - 实际结果: 

#### 请求重写
- [ ] **TC-12-005**: 访问 `/about`，验证重写到 `/about-us`
  - 预期: URL 保持为 `/about`，但内容来自 `/about-us`
  - 实际结果: 

#### Cookie 操作
- [ ] **TC-12-006**: 首次访问任意页面，验证设置 Cookie
  - 预期: 响应头包含 `Set-Cookie: test-cookie=v12-middleware`
  - 实际结果: 

- [ ] **TC-12-007**: 再次访问，验证 Cookie 被读取
  - 预期: 中间件能读取到之前设置的 Cookie
  - 实际结果: 

#### 响应头设置
- [ ] **TC-12-008**: 访问 `/api/test`，验证响应头
  - 预期: 响应头包含 `x-middleware-version`, `x-request-path`
  - 实际结果: 

#### User-Agent 处理
- [ ] **TC-12-009**: 使用正常浏览器访问，验证 Bot 检测
  - 预期: 响应头不包含 `x-detected-bot`
  - 实际结果: 

- [ ] **TC-12-010**: 使用 Bot User-Agent 访问，验证 Bot 检测
  - 预期: 响应头包含 `x-detected-bot: true`
  - 实际结果: 

### 1.2 API 路由测试

- [ ] **TC-12-011**: 访问 `/api/test`，验证 API 路由正常工作
  - 预期: 返回 JSON 响应，包含中间件添加的信息
  - 实际结果: 

### 1.3 部署验证

- [ ] **TC-12-012**: 在 边缘平台 上构建成功
  - 预期: 构建无错误
  - 实际结果: 

- [ ] **TC-12-013**: 在 边缘平台 上中间件正常执行
  - 预期: 部署后中间件功能正常
  - 实际结果: 

---

## 二、Next.js 13.x/14.x 测试用例

### 2.1 基础功能测试

#### 路径匹配（增强）
- [ ] **TC-13-001**: 访问 `/api/test`，验证中间件执行
  - 预期: 响应头包含 `x-middleware-version: v13`
  - 实际结果: 

- [ ] **TC-13-002**: 访问 `/protected/dashboard`，验证中间件执行
  - 预期: 响应头包含中间件标识
  - 实际结果: 

#### userAgent() Helper
- [ ] **TC-13-003**: 使用 userAgent() helper 检测 Bot
  - 预期: 正确识别 Bot，响应头包含 `x-detected-bot`, `x-bot-name`
  - 实际结果: 

#### 改进的 Cookies API
- [ ] **TC-13-004**: 使用新 API 设置 Cookie
  - 预期: Cookie 正确设置，包含 httpOnly, sameSite 等选项
  - 实际结果: 

- [ ] **TC-13-005**: 使用新 API 读取 Cookie
  - 预期: 能正确读取 Cookie 值
  - 实际结果: 

#### 请求头修改
- [ ] **TC-13-006**: 验证请求头被修改并传递到 API 路由
  - 预期: API 路由能接收到 `x-forwarded-by: middleware-v13`
  - 实际结果: 

#### 认证检查（基于 Header）
- [ ] **TC-13-007**: 访问 `/protected/dashboard` 无 Authorization header
  - 预期: 重定向到 `/login`
  - 实际结果: 

- [ ] **TC-13-008**: 访问 `/protected/dashboard` 带 Authorization header
  - 预期: 正常访问，不被重定向
  - 实际结果: 

#### 基于 Cookie 的条件处理
- [ ] **TC-13-009**: 设置 theme cookie，验证响应头包含主题信息
  - 预期: 响应头包含 `x-theme`
  - 实际结果: 

### 2.2 增强功能测试

- [ ] **TC-13-010**: 验证增强的 matcher 配置
  - 预期: 静态文件被正确排除
  - 实际结果: 

- [ ] **TC-13-011**: 验证时间戳响应头
  - 预期: 响应头包含 `x-timestamp`，格式为 ISO 字符串
  - 实际结果: 

### 2.3 部署验证

- [ ] **TC-13-012**: 在 边缘平台 上构建成功
  - 预期: 构建无错误
  - 实际结果: 

- [ ] **TC-13-013**: 在 边缘平台 上所有功能正常
  - 预期: 部署后所有中间件功能正常
  - 实际结果: 

---

## 三、Next.js 15.x 测试用例

### 3.1 Node.js Runtime 测试

- [ ] **TC-15-001**: 验证使用 Node.js runtime
  - 预期: 响应头包含 `x-runtime: nodejs`
  - 实际结果: 

- [ ] **TC-15-002**: 验证中间件版本标识
  - 预期: 响应头包含 `x-middleware-version: v15`
  - 实际结果: 

### 3.2 基础功能测试

#### 路径匹配
- [ ] **TC-15-003**: 访问 `/api/test`，验证中间件执行
  - 预期: 响应头包含中间件标识
  - 实际结果: 

- [ ] **TC-15-004**: 访问 `/admin/dashboard`，验证中间件执行
  - 预期: 响应头包含中间件标识
  - 实际结果: 

#### 认证检查（基于 Cookie）
- [ ] **TC-15-005**: 访问 `/admin/dashboard` 无 session cookie
  - 预期: 重定向到 `/login`
  - 实际结果: 

- [ ] **TC-15-006**: 访问 `/admin/dashboard` 带 session cookie
  - 预期: 正常访问，不被重定向
  - 实际结果: 

#### 请求头修改
- [ ] **TC-15-007**: 验证请求头被修改
  - 预期: API 路由能接收到 `x-forwarded-by: middleware-v15-nodejs`, `x-original-path`
  - 实际结果: 

#### 安全头设置
- [ ] **TC-15-008**: 访问 `/api/*` 路径，验证安全头
  - 预期: 响应头包含 `x-content-type-options: nosniff`, `x-frame-options: DENY`
  - 实际结果: 

### 3.3 Node.js API 可用性测试

- [ ] **TC-15-009**: 验证可以使用 Node.js API（如 Date.now()）
  - 预期: 时间戳正确生成
  - 实际结果: 

### 3.4 部署验证

- [ ] **TC-15-010**: 在 边缘平台 上构建成功
  - 预期: 构建无错误
  - 实际结果: 

- [ ] **TC-15-011**: 在 边缘平台 上 Node.js runtime 正常工作
  - 预期: 部署后 Node.js runtime 功能正常
  - 实际结果: 

---

## 四、Next.js 16.x 测试用例

### 4.1 Proxy 重命名测试

- [ ] **TC-16-001**: 验证使用 proxy.ts 文件
  - 预期: 响应头包含 `x-file-name: proxy.ts`
  - 实际结果: 

- [ ] **TC-16-002**: 验证 proxy() 函数执行
  - 预期: 响应头包含 `x-proxy-version: v16`
  - 实际结果: 

- [ ] **TC-16-003**: 验证强制使用 Node.js runtime
  - 预期: 响应头包含 `x-runtime: nodejs`
  - 实际结果: 

### 4.2 异步 API 测试

- [ ] **TC-16-004**: 验证 userAgent() 异步调用
  - 预期: 正确使用 `await userAgent(request)`
  - 实际结果: 

- [ ] **TC-16-005**: 验证异步 API 正常工作
  - 预期: 所有异步操作正常执行
  - 实际结果: 

### 4.3 基础功能测试

#### 路径匹配
- [ ] **TC-16-006**: 访问 `/api/test`，验证 proxy 执行
  - 预期: 响应头包含 proxy 标识
  - 实际结果: 

- [ ] **TC-16-007**: 访问 `/secure/dashboard`，验证 proxy 执行
  - 预期: 响应头包含 proxy 标识
  - 实际结果: 

#### 认证检查
- [ ] **TC-16-008**: 访问 `/secure/dashboard` 无 session cookie
  - 预期: 重定向到 `/login`
  - 实际结果: 

- [ ] **TC-16-009**: 访问 `/secure/dashboard` 带 session cookie
  - 预期: 正常访问，不被重定向
  - 实际结果: 

#### 请求头修改
- [ ] **TC-16-010**: 验证请求头被修改
  - 预期: API 路由能接收到 `x-forwarded-by: proxy-v16`
  - 实际结果: 

#### 安全头设置
- [ ] **TC-16-011**: 访问 `/api/*` 路径，验证安全头
  - 预期: 响应头包含多个安全头（nosniff, DENY, xss-protection）
  - 实际结果: 

### 4.4 响应体限制测试

- [ ] **TC-16-012**: 验证不能直接返回响应体（如果代码中有尝试）
  - 预期: 不会返回 JSON 响应体，只能 redirect/rewrite
  - 实际结果: 

### 4.5 向后兼容性测试

- [ ] **TC-16-013**: 验证 middleware.ts 是否仍可用（如果存在）
  - 预期: 可能被标记为弃用，但功能可能仍可用
  - 实际结果: 

### 4.6 部署验证

- [ ] **TC-16-014**: 在 边缘平台 上构建成功
  - 预期: 构建无错误
  - 实际结果: 

- [ ] **TC-16-015**: 在 边缘平台 上 proxy.ts 正常工作
  - 预期: 部署后 proxy 功能正常
  - 实际结果: 

- [ ] **TC-16-016**: 验证 边缘平台 支持 proxy.ts
  - 预期: 平台能正确识别和执行 proxy.ts
  - 实际结果: 

---

## 五、跨版本对比测试

### 5.1 功能一致性测试

- [ ] **TC-CROSS-001**: 对比各版本的路径匹配行为
  - 预期: 功能一致，配置方式可能不同
  - 实际结果: 

- [ ] **TC-CROSS-002**: 对比各版本的重定向行为
  - 预期: 功能一致
  - 实际结果: 

- [ ] **TC-CROSS-003**: 对比各版本的重写行为
  - 预期: 功能一致
  - 实际结果: 

- [ ] **TC-CROSS-004**: 对比各版本的 Cookie 操作
  - 预期: v12 使用旧 API，v13+ 使用新 API，功能一致
  - 实际结果: 

### 5.2 性能对比测试

- [ ] **TC-CROSS-005**: 对比 Edge runtime 和 Node.js runtime 性能
  - 预期: Edge runtime 通常更快
  - 实际结果: 

- [ ] **TC-CROSS-006**: 对比各版本的响应时间
  - 预期: 记录各版本的平均响应时间
  - 实际结果: 

---

## 六、边缘平台 平台特定测试

### 6.1 构建和部署

- [ ] **TC-EDGEONE-001**: 验证构建命令正确
  - 预期: `npm run build` 成功执行
  - 实际结果: 

- [ ] **TC-EDGEONE-002**: 验证输出目录配置
  - 预期: `.next` 目录正确生成
  - 实际结果: 

- [ ] **TC-EDGEONE-003**: 验证 Node.js 版本选择
  - 预期: 选择的 Node.js 版本与 Next.js 版本兼容
  - 实际结果: 

### 6.2 运行时验证

- [ ] **TC-EDGEONE-004**: 验证中间件在 边缘平台 上执行
  - 预期: 中间件正常执行，响应头正确
  - 实际结果: 

- [ ] **TC-EDGEONE-005**: 验证静态资源不受中间件影响
  - 预期: 静态资源正常加载，中间件不执行
  - 实际结果: 

- [ ] **TC-EDGEONE-006**: 验证 API 路由与中间件协作
  - 预期: API 路由正常工作，能接收到中间件修改的请求头
  - 实际结果: 

### 6.3 日志和监控

- [ ] **TC-EDGEONE-007**: 检查构建日志
  - 预期: 无错误或警告
  - 实际结果: 

- [ ] **TC-EDGEONE-008**: 检查运行时日志
  - 预期: 中间件执行日志正常（如果有）
  - 实际结果: 

- [ ] **TC-EDGEONE-009**: 验证错误处理
  - 预期: 中间件错误不会导致应用崩溃
  - 实际结果: 

### 6.4 性能测试

- [ ] **TC-EDGEONE-010**: 测试中间件对页面加载速度的影响
  - 预期: 影响在可接受范围内（< 100ms）
  - 实际结果: 

- [ ] **TC-EDGEONE-011**: 测试中间件对 API 响应时间的影响
  - 预期: 影响在可接受范围内（< 50ms）
  - 实际结果: 

---

## 七、边界情况和错误处理测试

### 7.1 异常情况

- [ ] **TC-EDGE-001**: 测试无效的 matcher 配置
  - 预期: 构建时或运行时给出错误提示
  - 实际结果: 

- [ ] **TC-EDGE-002**: 测试中间件中抛出错误
  - 预期: 错误被正确处理，不影响应用
  - 实际结果: 

- [ ] **TC-EDGE-003**: 测试超长路径
  - 预期: 中间件能正常处理
  - 实际结果: 

- [ ] **TC-EDGE-004**: 测试特殊字符路径
  - 预期: 中间件能正常处理
  - 实际结果: 

### 7.2 并发测试

- [ ] **TC-EDGE-005**: 测试并发请求
  - 预期: 中间件能正确处理并发请求
  - 实际结果: 

---

## 八、测试总结

### 测试统计

- **总测试用例数**: 
- **通过**: 
- **失败**: 
- **跳过**: 
- **通过率**: %

### 问题汇总

| 问题编号 | 测试用例 | 问题描述 | 严重程度 | 状态 |
|---------|---------|---------|---------|------|
| | | | | |
| | | | | |

### 版本兼容性总结

| Next.js 版本 | 边缘平台 支持 | 主要问题 | 建议 |
|-------------|-------------------|---------|------|
| 12.x | | | |
| 13.x/14.x | | | |
| 15.x | | | |
| 16.x | | | |

### 结论

**测试结论**: 

**建议**: 

**备注**: 

---

## 附录：测试工具和命令

### 本地测试命令

```bash
# 进入对应版本目录
cd versions/v12  # 或其他版本

# 安装依赖
npm install

# 运行开发服务器
npm run dev

# 构建测试
npm run build
```

### 测试工具

- **浏览器开发者工具**: 检查响应头、Cookie、网络请求
- **curl**: 测试 API 和自定义请求头
  ```bash
  # 测试 API
  curl http://localhost:3000/api/test
  
  # 测试带自定义 header
  curl -H "Authorization: Bearer token" http://localhost:3000/protected/dashboard
  
  # 测试 Bot User-Agent
  curl -H "User-Agent: Googlebot" http://localhost:3000/api/test
  ```
- **Postman**: 用于更复杂的 API 测试

### 边缘平台 部署检查清单

- [ ] Git 仓库已连接
- [ ] 构建命令已配置
- [ ] 输出目录已配置
- [ ] Node.js 版本已选择
- [ ] 环境变量已配置（如有需要）
- [ ] 自定义域名已配置（如有需要）

---

**文档版本**: 1.0  
**最后更新**: 
